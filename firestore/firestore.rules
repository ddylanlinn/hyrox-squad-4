rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ==================== Helper Functions ====================
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if user is the document owner
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Check if user has auth binding
    function hasAuthBinding() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/auth-bindings/$(request.auth.uid));
    }
    
    // Get bound app user ID from auth binding
    function getBoundUserId() {
      return get(/databases/$(database)/documents/auth-bindings/$(request.auth.uid)).data.appUserId;
    }
    
    // Check if user is member of a squad
    function isSquadMember(squadId) {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/squads/$(squadId)/members/$(getBoundUserId()));
    }
    
    // Check if user is squad captain
    function isSquadCaptain(squadId) {
      let squad = get(/databases/$(database)/documents/squads/$(squadId)).data;
      return isAuthenticated() && squad.captainId == getBoundUserId();
    }
    
    // Validate workout data
    function isValidWorkout() {
      let data = request.resource.data;
      return data.keys().hasAll(['id', 'userId', 'squadId', 'date', 'completedAt', 'imageUrl', 'createdAt']) &&
             data.id is string &&
             data.userId is string &&
             data.squadId is string &&
             data.date is string &&
             data.date.matches('^[0-9]{4}-[0-9]{2}-[0-9]{2}$') &&  // YYYY-MM-DD format
             data.completedAt is timestamp &&
             data.imageUrl is string &&
             data.imageUrl.matches('^https://.*') &&
             data.createdAt is timestamp &&
             (data.note == null || data.note is string);
    }
    
    // Validate user stats data
    function isValidUserStats() {
      let data = request.resource.data;
      return data.keys().hasAll(['date', 'userId', 'count', 'workoutIds', 'createdAt', 'updatedAt']) &&
             data.date is string &&
             data.date.matches('^[0-9]{4}-[0-9]{2}-[0-9]{2}$') &&
             data.userId is string &&
             data.count is number &&
             data.count >= 0 &&
             data.count <= 10 &&  // Max 10 workouts per day
             data.workoutIds is list &&
             data.createdAt is timestamp &&
             data.updatedAt is timestamp;
    }
    
    // Validate auth binding data (for creation only)
    function isValidAuthBinding() {
      let data = request.resource.data;
      return data.keys().hasAll(['firebaseAuthUid', 'appUserId', 'provider', 'createdAt', 'updatedAt']) &&
             data.firebaseAuthUid == request.auth.uid &&  // Must match authenticated user
             data.firebaseAuthUid is string &&
             data.appUserId is string &&
             data.appUserId.matches('^u[0-9]+$') &&  // Format: u1, u2, u3, etc.
             data.provider is string &&
             (data.email == null || data.email is string) &&
             (data.displayName == null || data.displayName is string) &&
             data.createdAt is timestamp &&
             data.updatedAt is timestamp;
    }
    
    // ==================== Auth Bindings ====================
    
    match /auth-bindings/{authUid} {
      // Allow users to read their own binding
      allow read: if isAuthenticated() && request.auth.uid == authUid;
      
      // Allow users to create their own binding (one time only)
      allow create: if isAuthenticated() && 
                       request.auth.uid == authUid && 
                       isValidAuthBinding() &&
                       !exists(/databases/$(database)/documents/auth-bindings/$(authUid));
      
      // Allow users to update only the updatedAt timestamp
      allow update: if isAuthenticated() && 
                       request.auth.uid == authUid &&
                       request.resource.data.diff(resource.data).affectedKeys().hasOnly(['updatedAt']) &&
                       request.resource.data.updatedAt is timestamp;
      
      // No delete allowed
      allow delete: if false;
    }
    
    // ==================== Squads ====================
    
    match /squads/{squadId} {
      // All authenticated users can read squad data
      allow read: if hasAuthBinding();
      
      // Squad members can update statistics fields (totalWorkouts, lastActivityDate, streaks, updatedAt)
      // Squad captain can update all fields except id, createdAt, memberIds, memberCount
      allow update: if isSquadMember(squadId) && (
                       // Members can update only statistics fields (any subset of allowed fields)
                       !request.resource.data.diff(resource.data).affectedKeys().hasAny(['id', 'createdAt', 'memberIds', 'memberCount', 'name', 'description', 'competitionDate', 'captainId', 'targetDailyWorkouts', 'color', 'isActive']) ||
                       // Captain can update other fields (but not protected ones)
                       (isSquadCaptain(squadId) &&
                        !request.resource.data.diff(resource.data).affectedKeys().hasAny(['id', 'createdAt', 'memberIds', 'memberCount']))
                     );
      
      // Create and delete require admin access (implement via Cloud Functions or admin SDK)
      allow create, delete: if false;
      
      // ==================== Squad Members Subcollection ====================
      
      match /members/{userId} {
        // Squad members can read all members
        allow read: if isSquadMember(squadId);
        
        // Members can be added by squad captain or system
        // (Can be managed via Cloud Functions for better control)
        allow create: if isSquadCaptain(squadId);
        
        // Member stats can be updated by the user themselves or squad captain
        allow update: if getBoundUserId() == userId || isSquadCaptain(squadId);
        
        // Members can be removed by squad captain
        allow delete: if isSquadCaptain(squadId);
      }
    }
    
    // ==================== Users ====================
    
    match /users/{userId} {
      // All authenticated users can read other users (for displaying squad members)
      allow read: if hasAuthBinding();
      
      // Users can only update their own profile and specific fields
      allow update: if getBoundUserId() == userId &&
                       // Cannot modify id, createdAt, and statistics fields directly
                       !request.resource.data.diff(resource.data).affectedKeys().hasAny(['id', 'createdAt']);
      
      // Create and delete require admin access
      allow create, delete: if false;
      
      // ==================== User Daily Stats Subcollection ====================
      
      match /stats/{date} {
        // Users can read their own stats
        allow read: if getBoundUserId() == userId;
        
        // Users can create/update their own stats (automated by createWorkout)
        allow create, update: if getBoundUserId() == userId && 
                                 isValidUserStats() &&
                                 date.matches('^[0-9]{4}-[0-9]{2}-[0-9]{2}$');
        
        // No delete allowed
        allow delete: if false;
      }
    }
    
    // ==================== Workouts ====================
    
    match /workouts/{workoutId} {
      // Squad members can read workouts from their squad
      allow read: if hasAuthBinding() && 
                     isSquadMember(resource.data.squadId);
      
      // Users can create workout records for themselves
      allow create: if hasAuthBinding() && 
                       getBoundUserId() == request.resource.data.userId &&
                       isSquadMember(request.resource.data.squadId) &&
                       isValidWorkout() &&
                       workoutId == request.resource.data.id;
      
      // Users can update only their own workouts (e.g., update note)
      allow update: if hasAuthBinding() && 
                       getBoundUserId() == resource.data.userId &&
                       // Cannot modify core fields
                       !request.resource.data.diff(resource.data).affectedKeys().hasAny(['id', 'userId', 'squadId', 'date', 'completedAt', 'imageUrl', 'createdAt']);
      
      // Users can delete only their own workouts
      allow delete: if hasAuthBinding() && 
                       getBoundUserId() == resource.data.userId;
    }
    
    // ==================== Default Deny ====================
    
    // Deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
